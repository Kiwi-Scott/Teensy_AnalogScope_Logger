<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Gas Resonant Cavity Scope</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: sans-serif; padding: 20px; background-color: #111; color: #eee; }
    h2 { margin-bottom: 0.5em; }
  
    label, input, button, select { margin: 0.5em 0; display: block; }
  
    .scope-container { width: 100%; height: 400px; overflow: hidden; }
  
    canvas { background-color: #000; border: 1px solid #555; width: 100% !important; height: 100% !important; }
  
    .trace-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
  
    .trace-buttons button { flex: 1; min-width: 100px; padding: 5px; background-color: #222; color: #eee; border: 1px solid #555; border-radius: 5px; cursor: pointer; }
  
    .trace-buttons button.active { background-color: #444; font-weight: bold; }
  
    .parameters-section { margin-top: 20px; }
  
    details { margin-top: 1em; background-color: #222; padding: 10px; border-radius: 5px; border: 1px solid #555; }
  
    summary { font-weight: bold; cursor: pointer; }
  
    .derived { background-color: #1a1a1a; padding: 10px; border-radius: 5px; margin-top: 10px; }
  
    .derived label { color: #ccc; font-weight: bold; margin-top: 5px; }
  
    .derived .calc-field { color: #0ff; font-weight: normal; margin-left: 10px; display: inline-block; }
  
    .segment-entry { margin-left: 1em; padding-left: 1em; border-left: 2px solid #444; margin-bottom: 10px; }
  
    .highlight-calc { color: #0ff; font-style: italic; }
  
    .axis-label { color: #aaa; font-size: 0.85em; font-style: italic; }
  
    .scope-overlay { margin-top: 1em; padding: 10px; background-color: #222; border-radius: 5px; border: 1px solid #555; }
  
    .scope-overlay label { display: inline-block; width: 200px; margin-right: 10px; }
  
    .radio-row { margin-top: 0.5em; }
  
    .warning { color: orange; font-size: 0.9em; font-style: italic; margin-left: 10px; }
  </style>
</head>
<body>
<h2>Stan Meyer's Gas Resonant Cavity Scope</h2>
<div class="scope-container">
<canvas id="mainChart"></canvas>
</div>
<div class="trace-buttons">
<button class="active" onclick="selectTrace('voltage', event)">WFC Voltage</button>
<button onclick="selectTrace('lmd', event)">LMD Current</button>
<button onclick="selectTrace('tem', event)">TEM Current</button>
<button onclick="selectTrace('esr', event)">Dynamic ESR</button>
<button onclick="selectTrace('res', event)">Resonant Frequency</button>
<button onclick="selectTrace('dty', event)">Duty Cycle</button>
<button onclick="selectTrace('gte', event)">Gate Time</button>
<button onclick="selectTrace('brk', event)">Breakdown</button>
</div>
<div>
<button id="recalcSimBtn" onclick="recalculateDefaults(); /* simulate() */" style="background-color: #282; color: #fff; font-weight: bold;">Recalculate Settings &amp; Simulate</button>
<span id="settingsStatus" style="margin-left: 1em; font-weight: bold; color: #2f2;">Settings are current</span>
</div>
<div class="parameters-section"> <!-- add default collapsed sub sections per device: WFC, Attn_Pri, Attn_Sec/Seg, VIC_Pri, VIC_Sec, VIC_PosChoke, VIC_NegChoke, .-->
<details>
<summary>Input Voltage And Simulation Duration</summary>
<label for="voltage">Input Voltage (V):</label>
<input id="voltageIn" onchange="flagSettingsChanged()" type="number" value="400"/>
<label for="simTime">Simulation Duration (ms):</label>
<input id="simTime" type="number" value="5"/>
</details>
<details>
<summary>VIC Core Parameters</summary>
<label for="vicCoreArea">VIC Core Cross-Sectional Area (cm¬≤):</label>
<input id="vicCoreArea" onchange="flagSettingsChanged()" step="0.1" type="number" value="3.2"/>
</details>
<details>
<summary>WFC Parameters</summary>
<label for="gap">WFC Gap (mm):</label>
<input id="gap" min="0.1" onchange="flagSettingsChanged()" step="0.1" type="number" value="0.5"/>
<!--Placeholder for WFC individual cell dimensions and parallel/series connections for capacitance calculations in derived section-->
<label for="wfcCap">WFC Capacitance (pF):</label>
<input id="wfcCap" onchange="flagSettingsChanged()" type="number" value="150"/> <!--To be moved to dervied section, calculated from dimentions and connections-->
</details>
<details>
<summary>Attenuation/Step-up Transformer Parameters</summary>
<label for="attenSecL">Attenuation/Step-up Transformer Secondary Segment Inductance (mH):</label>
<input id="attenSecL" onchange="flagSettingsChanged()" type="number" value="1300"/>
<label for="attenRatio">Attenuation/Step-up Transformer Primary to BASE Secondary Segment Turns Ratio (P1:Sx):</label>
<input id="attenRatio" onchange="flagSettingsChanged()" type="number" value="1"/>
<label for="attenSecSegmentCount">Attenuation/Step-up Transformer Number of Segments:</label>
<input id="attenSecSegmentCount" max="50" min="1" onchange="flagSettingsChanged()" type="number" value="3"/>
<label for="attenCoreArea">Attenuation/Step-up Transformer Core Cross-Sectional Area (cm¬≤):</label>
<input id="attenCoreArea" onchange="flagSettingsChanged()" step="0.1" type="number" value="3.2"/>
<details>
<summary>
        Attenuation/Step-up Transformer Primary Wire Parameters</summary>
<label for="attenPriBobbinWidth">Attenuation/Step-up Transformer Primary Bobbin Winding Width (mm):</label>
<input id="attenPriBobbinWidth" onchange="flagSettingsChanged()" step="1" type="number" value="45"/>
<label for="attenPriTurnPitch">Attenuation/Step-up Transformer Primary Copper Turn Pitch (wire size) (mm):</label>
<input id="attenPriTurnPitch" onchange="flagSettingsChanged()" step="0.01" type="number" value="0.3"/>
<label for="attenPriWireRes">Attenuation/Step-up Transformer Primary Copper Wire Resistance (Œ©/m):</label>
<input id="attenPriWireRes" onchange="flagSettingsChanged()" step="0.1" type="number" value="13.6"/> <!-- Change to realistic mm2 Copper resistance value-->
</details>
<details>
<summary>
       Attenuation/Step-up Transformer Secondary Wire Parameters</summary>
<div style="margin-bottom: 0.5em;">
<label>Attenuation/Step-up Transformer Secondary Material:</label>
<label style="display:inline; margin-right:1em;"><input checked="" id="attenSecMaterialCopper" name="attenSecMaterial" onchange="flagSettingsChanged()" type="radio" value="copper"/> Copper</label>
<label style="display:inline;"><input id="attenSecMaterialStainless" name="attenSecMaterial" onchange="flagSettingsChanged()" type="radio" value="stainless"/> Stainless Steel</label>
</div>
<label for="attenSecCopperTurnPitch">Attenuation/Step-up Transformer Secondary Copper Turn Pitch (wire size) (mm):</label>
<input id="attenSecCopperTurnPitch" onchange="flagSettingsChanged()" step="0.01" type="number" value="0.3"/>
<label for="attenSecCopperWireRes">Attenuation/Step-up Transformer Secondary Copper Wire Resistance (Œ©/m):</label>
<input id="attenSecCopperWireRes" onchange="flagSettingsChanged()" step="0.1" type="number" value="13.6"/> <!-- Change to realistic mm2 Copper resistance value-->
<label for="attenSecStainlessTurnPitch">Attenuation/Step-up Transformer Secondary Stainless Steel Secondaries Turn Pitch (wire size) (mm):</label>
<input id="attenSecStainlessTurnPitch" onchange="flagSettingsChanged()" step="0.01" type="number" value="0.3"/>
<label for="attenSecStainlessWireRes">Attenuation/Step-up Transformer Secondary Stainless Steel Secondaries Wire Resistance (Œ©/m):</label>
<input id="attenSecStainlessWireRes" onchange="flagSettingsChanged()" step="0.1" type="number" value="13.6"/>
<label for="attenSecBobbinWidth">Attenuation/Step-up Transformer Secondary Bobbin Winding Width per Segment (mm):</label>
<input id="attenSecBobbinWidth" onchange="flagSettingsChanged()" step="1" type="number" value="45"/>
</details>
</details>
<details>
<summary>VIC Secondary Side Parameters</summary>
<label for="vicSecL">VIC Secondary Inductance (mH):</label>
<input id="vicSecL" onchange="flagSettingsChanged()" type="number" value="1300"/>
<label for="vicRatio">VIC Turns Ratio (P:S):</label>
<input id="vicRatio" onchange="flagSettingsChanged()" type="text" value="1:5"/>
<label for="vicPosChokeL">VIC Positive Choke Inductance (mH):</label>
<input id="vicPosChokeL" onchange="flagSettingsChanged()" type="number" value="1300"/>
<label for="vicNegChokeL">VIC Negative Choke Inductance (mH):</label>
<input id="vicNegChokeL" onchange="flagSettingsChanged()" type="number" value="1300"/>
<summary>VIC Primary Wire Parameters</summary>
<label for="vicBobbinWidth">Common Bobbin Winding Width (mm):</label>
<input id="vicBobbinWidth" onchange="flagSettingsChanged()" step="1" type="number" value="45"/>
<label for="vicCopperTurnPitch">Copper Turn Pitch (wire size) (mm):</label>
<input id="vicCopperTurnPitch" onchange="flagSettingsChanged()" step="0.01" type="number" value="0.3"/>
<label for="vicCopperWireRes">Copper Wire Resistance (Œ©/m):</label>
<input id="vicCopperWireRes" onchange="flagSettingsChanged()" step="0.1" type="number" value="13.6"/> <!-- Change to realistic mm2 Copper resistance value-->
<summary>VIC Secondary Wire Parameters</summary>
<label for="vicStainlessTurnPitch">Stainless Steel Secondaries and Chokes Turn Pitch (wire size) (mm):</label>
<input id="vicStainlessTurnPitch" onchange="flagSettingsChanged()" step="0.01" type="number" value="0.3"/>
<label for="vicStainlessWireRes">Stainless Steel Secondaries and Chokes Wire Resistance (Œ©/m):</label>
<input id="vicStainlessWireRes" onchange="flagSettingsChanged()" step="0.1" type="number" value="13.6"/>
</details>
</div>
<div class="DerivedCoilParameters">
<details>
<summary>Derived VIC Coil Parameters</summary>
<div class="derived" id="VICcoilDerived">
<details>
<summary>Derived VIC Primary Coil Parameters</summary>
<div><label>VIC Primary Resistance (Œ©):</label><span class="calc-field" id="vicPriR">(pending)</span></div>
<div><label>VIC Primary Inductance (mH):</label><span class="calc-field" id="vicPriL">(pending)</span></div>
<div><label>VIC Primary Estimated Turns:</label><span class="calc-field" id="vicPriTurns">(pending)</span></div>
<div><label>VIC Primary Wire Length (m):</label><span class="calc-field" id="vicPriLength">(pending)</span></div>
<div><label>VIC Primary Mean Diameter (mm):</label><span class="calc-field" id="vicPriDiam">(pending)</span></div>
<div><label>VIC Primary Winding Height (mm):</label><span class="calc-field" id="vicPriHeight">(pending)</span><span class="warning" id="vicPriWarn"></span></div>
<div><label>VIC Primary Capacitance (nF):</label><span class="calc-field" id="vicChokeC">(pending)</span></div>
</details>
<details>
<summary>Derived VIC Secondary Coil Parameters</summary>
<div><label>VIC Secondary Resistance (Œ©):</label><span class="calc-field" id="vicSecR">(pending)</span></div>
<div><label>VIC Secondary Estimated Turns:</label><span class="calc-field" id="vicSecTurns">(pending)</span></div>
<div><label>VIC Secondary Wire Length (m):</label><span class="calc-field" id="vicSecLength">(pending)</span></div>
<div><label>VIC Secondary Mean Diameter (mm):</label><span class="calc-field" id="vicSecDiam">(pending)</span></div>
<div><label>VIC Secondary Winding Height (mm):</label><span class="calc-field" id="vicSecHeight">(pending)</span><span class="warning" id="vicPriWarn"></span></div>
<div><label>VIC Secondary Capacitance (nF):</label><span class="calc-field" id="vicSecC">(pending)</span></div>
</details>
<details>
<summary>Derived VIC Positive Choke Parameters</summary>
<div><label>VIC Positive Choke Resistance (Œ©):</label><span class="calc-field" id="vicPosChokeR">(pending)</span></div>
<div><label>VIC Positive Choke Estimated Turns:</label><span class="calc-field" id="vicPosChokeTurns">(pending)</span></div>
<div><label>VIC Positive Choke Wire Length (m):</label><span class="calc-field" id="vicPosChokeLength">(pending)</span></div>
<div><label>VIC Positive Choke Mean Diameter (mm):</label><span class="calc-field" id="vicPosChokeDiam">(pending)</span></div>
<div><label>VIC Positive Choke Winding Height (mm):</label><span class="calc-field" id="vicPosChokeHeight">(pending)</span><span class="warning" id="vicPriWarn"></span></div>
<div><label>VIC Positive Choke Capacitance (nF):</label><span class="calc-field" id="vicPosChokeC">(pending)</span></div>
</details>
<details>
<summary>Derived VIC Negative Choke Parameters</summary>
<div><label>VIC Negative Choke Resistance (Œ©):</label><span class="calc-field" id="vicNegChokeR">(pending)</span></div>
<div><label>VIC Negative Choke Estimated Turns:</label><span class="calc-field" id="vicNegChokeTurns">(pending)</span></div>
<div><label>VIC Negative Choke Wire Length (m):</label><span class="calc-field" id="vicNegChokeLength">(pending)</span></div>
<div><label>VIC Negative Choke Mean Diameter (mm):</label><span class="calc-field" id="vicNegChokeDiam">(pending)</span></div>
<div><label>VIC Negative Choke Winding Height (mm):</label><span class="calc-field" id="vicNegChokeHeight">(pending)</span><span class="warning" id="vicPriWarn"></span></div>
<div><label>VIC Negative Choke Capacitance (nF):</label><span class="calc-field" id="vicNegChokeC">(pending)</span></div>
</details>
<details>
<summary>Derived VIC Totals</summary>
<label>Total VIC Capacitance:</label><span class="calc-field" id="vicTotalCap">(pending)</span><br/>
<label>Total VIC Resistance:</label><span class="calc-field" id="vicTotalRes">(pending)</span><br/>
<label>Total VIC Inductance:</label><span class="calc-field" id="vicTotalInd">(pending)</span><br/>
<label>Total VIC LMD:TEM Ratio (Secondary WFC Side):</label><span class="calc-field" id="vicLmdTem">(pending)</span></details></div>
</details>
</div>
<div>
<details>
<summary>Derived Attenuation/Step-up Transformer Coil Parameters</summary>
<div class="derived" id="AttnDerived">
<details>
<summary>Derived Attenuation/Step-up Transformer Primary</summary>
<div><label>Attenuation/Step-up Transformer Primary Resistance (Œ©):</label><span class="calc-field" id="attnPriR">(pending)</span></div>
<div><label>Attenuation/Step-up Transformer Primary Estimated Turns:</label><span class="calc-field" id="attnPriTurns">(pending)</span></div>
<div><label>Attenuation/Step-up Transformer Primary Wire Length (m):</label><span class="calc-field" id="attnPriLength">(pending)</span></div>
<div><label>Attenuation/Step-up Transformer Primary Mean Diameter (mm):</label><span class="calc-field" id="attnPriDiam">(pending)</span></div>
<div><label>Attenuation/Step-up Transformer Primary Winding Height (mm):</label><span class="calc-field" id="attnPriHeight">(pending)</span><span class="warning" id="vicPriWarn"></span></div>
<div><label>Attenuation/Step-up Transformer Primary Capacitance (nF):</label><span class="calc-field" id="attnPriC">(pending)</span></div>
</details>
<details>
<summary>Derived Attenuation/Step-up Transformer Secondary Segment</summary>
<div style="display: flex; gap: 2em;">
<div>
<div style="font-weight:bold; color:#0ff;">Copper</div>
<div><label>Resistance (Œ©):</label><span class="calc-field" id="attnSecRCopper">(pending)</span></div>
<div><label>Estimated Turns:</label><span class="calc-field" id="attnSecTurnsCopper">(pending)</span></div>
<div><label>Wire Length (m):</label><span class="calc-field" id="attnSecLengthCopper">(pending)</span></div>
<div><label>Mean Diameter (mm):</label><span class="calc-field" id="attnSecDiamCopper">(pending)</span></div>
<div><label>Winding Height (mm):</label><span class="calc-field" id="attnSecHeightCopper">(pending)</span></div>
<div><label>Capacitance (nF):</label><span class="calc-field" id="attnSecCCopper">(pending)</span></div>
</div>
<div>
<div style="font-weight:bold; color:#ff0;">Stainless Steel</div>
<div><label>Resistance (Œ©):</label><span class="calc-field" id="attnSecRStainless">(pending)</span></div>
<div><label>Estimated Turns:</label><span class="calc-field" id="attnSecTurnsStainless">(pending)</span></div>
<div><label>Wire Length (m):</label><span class="calc-field" id="attnSecLengthStainless">(pending)</span></div>
<div><label>Mean Diameter (mm):</label><span class="calc-field" id="attnSecDiamStainless">(pending)</span></div>
<div><label>Winding Height (mm):</label><span class="calc-field" id="attnSecHeightStainless">(pending)</span></div>
<div><label>Capacitance (nF):</label><span class="calc-field" id="attnSecCStainless">(pending)</span></div>
</div>
</div>
<div style="margin-top:0.5em;">
<span style="font-weight:bold; color:#fff;">Used for simulation: </span>
<span id="attnSecMaterialUsed" style="font-weight:bold; color:#0f0;">Copper</span>
</div>
</details>
<details>
<summary>Derived Attenuation/Step-up Transformer Secondary Segment Acummulated Totals</summary>
<label>Estimated LMD:TEM Charge Ratio per Segment:</label><span class="calc-field" id="segAttnLmdTem">(pending)</span><br/>
<label>Matching Cap per Segment:</label><span class="calc-field" id="segMatchingCap">(pending)</span><br/>
<label>Estimated Segment Q-Factor:</label><span class="calc-field" id="segQFactor">(pending)</span><br/>
<label>Impedance Mismatch per Segment:</label><span class="calc-field" id="segMismatch">(pending)</span>
</details>
</div>
</details></div>
<div class="Avanced ESR Parameters">
<details>
<summary>Advances ESR Parameters</summary>
<div class="Advanced-ESR">
<details>
<summary>Advanced ESR Fitting Parameters</summary>
<label for="alphaV">Voltage Alpha (Œ±·µ•):</label>
<input id="alphaV" max="1" min="0" step="0.01" type="number" value="0.65"/>
<label for="tauV">Voltage Tau (œÑ·µ•):</label>
<input id="tauV" step="0.0001" type="number" value="0.001"/>
<label for="alphaF">Frequency Alpha (Œ±ùíª):</label>
<input id="alphaF" max="1" min="0" step="0.01" type="number" value="0.40"/>
<label for="tauF">Frequency Tau (œÑùíª):</label>
<input id="tauF" step="1e-6" type="number" value="1e-5"/>
<label for="esrWeight">Voltage Weighting Toward Breakdown:</label>
<input id="esrWeight" max="1" min="0" step="0.01" type="range" value="0.9"/>
</details>
</div>
</details></div>
<script>
    function selectTrace(type, event) {
      document.querySelectorAll('.trace-buttons button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      // TODO: Trigger trace visibility
    }
  
    function computeDualColeColeESR(voltage, frequencyHz) {
      const alphaV = parseFloat(document.getElementById("alphaV").value);
      const tauV = Math.max(parseFloat(document.getElementById("tauV").value), 1e-9);
      const alphaF = parseFloat(document.getElementById("alphaF").value);
      const tauF = Math.max(parseFloat(document.getElementById("tauF").value), 1e-9);
      const w = Math.max(2 * Math.PI * frequencyHz, 1e-3);

      const ReV = 1 / Math.sqrt(1 + Math.pow(w * tauV, 2 * (1 - alphaV)));
      const ReF = 1 / Math.sqrt(1 + Math.pow(w * tauF, 2 * (1 - alphaF)));

      const vBreakdownVal = parseFloat(document.getElementById("vBreakdown").textContent) || 18000;
      const baselineWeight = parseFloat(document.getElementById("esrWeight").value);
      const breakdownInfluence = voltage / vBreakdownVal;
      const voltageWeight = Math.min(baselineWeight * (1 + breakdownInfluence), 1);

      return voltageWeight * ReV + (1 - voltageWeight) * ReF;
    }

    // Flag settings as changed (require recalc)
    let settingsAreCurrent = true;
    function flagSettingsChanged() {
      if (settingsAreCurrent) {
        settingsAreCurrent = false;
        const btn = document.getElementById("recalcSimBtn");
        if (btn) btn.style.backgroundColor = "#a22";
        if (btn) btn.style.color = "#fff";
        const status = document.getElementById("settingsStatus");
        if (status) {
          status.textContent = "Settings changed - recalculate required";
          status.style.color = "#f22";
        }
      }
    }

    // Recalculate all derived values based on user inputs
    function recalculateDefaults() {

      // --- UI status update ---
      settingsAreCurrent = true;
      const btn = document.getElementById("recalcSimBtn");
      if (btn) btn.style.backgroundColor = "#282";
      if (btn) btn.style.color = "#fff";
      const status = document.getElementById("settingsStatus");
      if (status) {
        status.textContent = "Settings are current";
        status.style.color = "#2f2";
      }
      // Update breakdown voltage
      const gapMeters = parseFloat(document.getElementById("wfcGap")?.value) || 0.0015; // fallback 1.5mm
      const E_break = 3e6; // V/m (realistic breakdown field)
      const V_break = gapMeters * E_break;
      if (document.getElementById("vBreakdown")) {
        document.getElementById("vBreakdown").textContent = V_break.toFixed(0);
      }

      // --- Robust input validation for ALL required user inputs (VIC and Attenuation) ---
      // List of required input IDs for VIC and Attenuation/Step-up Transformer
      const requiredVICFields = [
        "vicCopperWireRes", "vicRatio", "vicCoreArea", "vicCopperTurnPitch", "vicBobbinWidth", "vicSecL",
        "vicStainlessWireRes", "vicStainlessTurnPitch", "vicPosChokeL", "vicNegChokeL"
      ];
      const requiredAttnFields = [
        "attenSecL", "attenRatio", "attenSecSegmentCount", "attenCoreArea",
        "attenPriBobbinWidth", "attenPriTurnPitch", "attenPriWireRes",
        "attenSecCopperTurnPitch", "attenSecCopperWireRes",
        "attenSecStainlessTurnPitch", "attenSecStainlessWireRes", "attenSecBobbinWidth"
      ];
      let missingVIC = false, missingAttn = false;
      let missingFields = [];
      // Check VIC fields
      for (const id of requiredVICFields) {
        const el = document.getElementById(id);
        if (!el || (el.tagName === 'INPUT' && el.type === 'number' && (el.value === undefined || el.value === null || el.value === '' || isNaN(parseFloat(el.value)))) ||
            (el.tagName === 'INPUT' && el.type === 'text' && (el.value === undefined || el.value === null || el.value === ''))) {
          missingVIC = true;
          missingFields.push(id);
        }
      }
      // Check Attenuation fields
      for (const id of requiredAttnFields) {
        const el = document.getElementById(id);
        if (!el || (el.tagName === 'INPUT' && el.type === 'number' && (el.value === undefined || el.value === null || el.value === '' || isNaN(parseFloat(el.value)))) ||
            (el.tagName === 'INPUT' && el.type === 'text' && (el.value === undefined || el.value === null || el.value === ''))) {
          missingAttn = true;
          if (!missingFields.includes(id)) missingFields.push(id);
        }
      }
      // Robust turns ratio parsing for VIC
      let vicRatioRaw = document.getElementById("vicRatio")?.value?.trim() || "";
      let vicRatioArr;
      if (vicRatioRaw.includes(":")) {
        vicRatioArr = vicRatioRaw.split(":").map(Number);
      } else if (vicRatioRaw.includes("/")) {
        vicRatioArr = vicRatioRaw.split("/").map(Number);
      } else if (vicRatioRaw.length > 0) {
        let n = Number(vicRatioRaw);
        vicRatioArr = [n, 1];
      } else {
        vicRatioArr = [1, 1];
      }
      if (!vicRatioArr[1] || isNaN(vicRatioArr[0]) || isNaN(vicRatioArr[1]) || vicRatioArr[1] === 0) {
        missingVIC = true;
        if (!missingFields.includes("vicRatio")) missingFields.push("vicRatio");
      }
      // Robust turns ratio parsing for Attenuation
      let attnRatioRaw = document.getElementById("attenRatio")?.value?.trim() || "";
      let attnRatioArr;
      if (attnRatioRaw.includes(":")) {
        attnRatioArr = attnRatioRaw.split(":").map(Number);
      } else if (attnRatioRaw.includes("/")) {
        attnRatioArr = attnRatioRaw.split("/").map(Number);
      } else if (attnRatioRaw.length > 0) {
        let n = Number(attnRatioRaw);
        attnRatioArr = [n, 1];
      } else {
        attnRatioArr = [1, 1];
      }
      if (!attnRatioArr[1] || isNaN(attnRatioArr[0]) || isNaN(attnRatioArr[1]) || attnRatioArr[1] === 0) {
        missingAttn = true;
        if (!missingFields.includes("attenRatio")) missingFields.push("attenRatio");
      }

      // If any required field is missing, show notification and set all derived fields to error
      if (missingVIC || missingAttn) {
        let msg = "Cannot calculate derived values. Please fill in or correct the following fields: " + missingFields.map(f => `\"${f}\"`).join(", ");
        [
          // VIC totals
          "vicTotalCap","vicTotalRes","vicTotalInd","vicLmdTem",
          // VIC derived
          "vicPriTurns","vicPriLength","vicPriDiam","vicPriHeight","vicPriR","vicPriL","vicChokeC",
          "vicSecTurns","vicSecLength","vicSecDiam","vicSecHeight","vicSecR","vicSecC",
          "vicPosChokeTurns","vicPosChokeLength","vicPosChokeDiam","vicPosChokeHeight","vicPosChokeR","vicPosChokeC",
          "vicNegChokeTurns","vicNegChokeLength","vicNegChokeDiam","vicNegChokeHeight","vicNegChokeR","vicNegChokeC",
          // Attenuation/step-up transformer derived
          "attnPriR","attnPriTurns","attnPriLength","attnPriDiam","attnPriHeight","attnPriC",
          "attnSecRCopper","attnSecTurnsCopper","attnSecLengthCopper","attnSecDiamCopper","attnSecHeightCopper","attnSecCCopper",
          "attnSecRStainless","attnSecTurnsStainless","attnSecLengthStainless","attnSecDiamStainless","attnSecHeightStainless","attnSecCStainless",
          // Attenuation/step-up transformer segment totals
          "segAttnLmdTem","segMatchingCap","segQFactor","segMismatch"
        ].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = msg; });
        if (status) {
          status.textContent = "Error: Missing or invalid user input(s). Please check all required fields.";
          status.style.color = "#ff0";
        }
        return;
      }

      try {
        // --- VIC Primary (Copper) ---
        const vicCopperWireRes = parseFloat(document.getElementById("vicCopperWireRes").value);
        // Robust VIC ratio parsing
        // (already parsed above)
        // Use the new VIC core area input
        const vicCoreArea = parseFloat(document.getElementById("vicCoreArea").value); // cm¬≤
        const vicCopperTurnPitch = parseFloat(document.getElementById("vicCopperTurnPitch").value); // mm
        const vicBobbinWidth = parseFloat(document.getElementById("vicBobbinWidth").value); // mm
        const vicSecL = parseFloat(document.getElementById("vicSecL").value); // mH

        const L_henry = vicSecL / 1000;
        const N_secondary = Math.sqrt((L_henry * 2) / (4e-7 * vicCoreArea / 1e4));
        const ratio = vicRatioArr[0] / vicRatioArr[1];
        const N_primary = N_secondary * ratio;

        const mean_diameter = 2 * Math.sqrt(vicCoreArea / Math.PI) * 10; // mm
        const turnLength = Math.PI * mean_diameter / 1000; // m
        const wireLength = N_primary * turnLength;
        const resistance = wireLength * vicCopperWireRes;

        const turnsPerLayer = Math.floor(vicBobbinWidth / vicCopperTurnPitch);
        const layers = Math.ceil(N_primary / turnsPerLayer);
        const windingHeight = layers * vicCopperTurnPitch;
        const maxHeight = vicBobbinWidth === 45 ? 20 : (vicBobbinWidth / 2 - 5);

        document.getElementById("vicPriTurns").textContent = N_primary.toFixed(1);
        document.getElementById("vicPriLength").textContent = wireLength.toFixed(2);
        document.getElementById("vicPriDiam").textContent = mean_diameter.toFixed(1);
        document.getElementById("vicPriHeight").textContent = windingHeight.toFixed(1);
        document.getElementById("vicPriR").textContent = resistance.toFixed(2);
        const heightWarn = document.getElementById("vicPriWarn");
        if (heightWarn) heightWarn.textContent = (windingHeight > maxHeight) ? " (Warning: Too tall for bobbin)" : "";
        document.getElementById("vicPriL").textContent = vicSecL.toFixed(2);

        // VIC Capacitance Estimate
        const d = 0.254; // mm, 30 AWG diameter
        const s = vicCopperTurnPitch; // spacing assumed = pitch
        const coilLength = N_secondary * s; // mm
        const eps0 = 8.854e-12;
        const epsr = 1.0006; // air
        const capPerLength = (Math.PI * eps0 * epsr) / Math.log(s / d);
        const totalCap = capPerLength * coilLength * 1e-3; // F

        document.getElementById("vicChokeC").textContent = (totalCap * 1e9).toFixed(2); // convert to nF

        // --- VIC Secondary (Stainless) ---
        const vicStainlessWireRes = parseFloat(document.getElementById("vicStainlessWireRes").value);
        const vicStainlessTurnPitch = parseFloat(document.getElementById("vicStainlessTurnPitch").value);
        // N_secondary already calculated above
        const vicSecMeanDiameter = mean_diameter; // assume same core
        const vicSecTurnLength = Math.PI * vicSecMeanDiameter / 1000; // m
        const vicSecWireLength = N_secondary * vicSecTurnLength;
        const vicSecResistance = vicSecWireLength * vicStainlessWireRes;
        const vicSecTurnsPerLayer = Math.floor(vicBobbinWidth / vicStainlessTurnPitch);
        const vicSecLayers = Math.ceil(N_secondary / vicSecTurnsPerLayer);
        const vicSecHeight = vicSecLayers * vicStainlessTurnPitch;
        document.getElementById("vicSecTurns").textContent = N_secondary.toFixed(1);
        document.getElementById("vicSecLength").textContent = vicSecWireLength.toFixed(2);
        document.getElementById("vicSecDiam").textContent = vicSecMeanDiameter.toFixed(1);
        document.getElementById("vicSecHeight").textContent = vicSecHeight.toFixed(1);
        document.getElementById("vicSecR").textContent = vicSecResistance.toFixed(2);
        // Capacitance (reuse above, but could be different for stainless)
        document.getElementById("vicSecC").textContent = (totalCap * 1e9).toFixed(2);

        // --- VIC Positive Choke (Stainless) ---
        const vicPosChokeL = parseFloat(document.getElementById("vicPosChokeL").value); // mH
        const L_posChoke = vicPosChokeL / 1000;
        const N_posChoke = Math.sqrt((L_posChoke * 2) / (4e-7 * vicCoreArea / 1e4));
        const vicPosChokeTurnLength = Math.PI * vicSecMeanDiameter / 1000; // m
        const vicPosChokeWireLength = N_posChoke * vicPosChokeTurnLength;
        const vicPosChokeResistance = vicPosChokeWireLength * vicStainlessWireRes;
        const vicPosChokeTurnsPerLayer = Math.floor(vicBobbinWidth / vicStainlessTurnPitch);
        const vicPosChokeLayers = Math.ceil(N_posChoke / vicPosChokeTurnsPerLayer);
        const vicPosChokeHeight = vicPosChokeLayers * vicStainlessTurnPitch;
        document.getElementById("vicPosChokeTurns").textContent = N_posChoke.toFixed(1);
        document.getElementById("vicPosChokeLength").textContent = vicPosChokeWireLength.toFixed(2);
        document.getElementById("vicPosChokeDiam").textContent = vicSecMeanDiameter.toFixed(1);
        document.getElementById("vicPosChokeHeight").textContent = vicPosChokeHeight.toFixed(1);
        document.getElementById("vicPosChokeR").textContent = vicPosChokeResistance.toFixed(2);
        document.getElementById("vicPosChokeC").textContent = (totalCap * 1e9).toFixed(2);

        // --- VIC Negative Choke (Stainless) ---
        const vicNegChokeL = parseFloat(document.getElementById("vicNegChokeL").value); // mH
        const L_negChoke = vicNegChokeL / 1000;
        const N_negChoke = Math.sqrt((L_negChoke * 2) / (4e-7 * vicCoreArea / 1e4));
        const vicNegChokeTurnLength = Math.PI * vicSecMeanDiameter / 1000; // m
        const vicNegChokeWireLength = N_negChoke * vicNegChokeTurnLength;
        const vicNegChokeResistance = vicNegChokeWireLength * vicStainlessWireRes;
        const vicNegChokeTurnsPerLayer = Math.floor(vicBobbinWidth / vicStainlessTurnPitch);
        const vicNegChokeLayers = Math.ceil(N_negChoke / vicNegChokeTurnsPerLayer);
        const vicNegChokeHeight = vicNegChokeLayers * vicStainlessTurnPitch;
        document.getElementById("vicNegChokeTurns").textContent = N_negChoke.toFixed(1);
        document.getElementById("vicNegChokeLength").textContent = vicNegChokeWireLength.toFixed(2);
        document.getElementById("vicNegChokeDiam").textContent = vicSecMeanDiameter.toFixed(1);
        document.getElementById("vicNegChokeHeight").textContent = vicNegChokeHeight.toFixed(1);
        document.getElementById("vicNegChokeR").textContent = vicNegChokeResistance.toFixed(2);
        document.getElementById("vicNegChokeC").textContent = (totalCap * 1e9).toFixed(2);

        // --- Attenuation/Step-up Transformer Primary (Copper) ---
        const attnPriWireRes = parseFloat(document.getElementById("attenPriWireRes").value);

        // Robust Attenuation/Step-up ratio parsing
        let attnRatioRaw = document.getElementById("attnRatio").value.trim();
        let attnRatioArr;
        if (attnRatioRaw.includes(":")) {
          attnRatioArr = attnRatioRaw.split(":").map(Number);
        } else if (attnRatioRaw.includes("/")) {
          attnRatioArr = attnRatioRaw.split("/").map(Number);
        } else if (attnRatioRaw.length > 0) {
          let n = Number(attnRatioRaw);
          attnRatioArr = [n, 1];
        } else {
          attnRatioArr = [1, 1];
        }
        if (!attnRatioArr[1] || isNaN(attnRatioArr[0]) || isNaN(attnRatioArr[1]) || attnRatioArr[1] === 0) attnRatioArr = [1, 1];

        const attnCoreArea = parseFloat(document.getElementById("attenCoreArea").value); // cm¬≤
        const attnPriTurnPitch = parseFloat(document.getElementById("attenPriTurnPitch").value); // mm
        const attnPriBobbinWidth = parseFloat(document.getElementById("attenPriBobbinWidth").value); // mm

        const N_attn_secondary = N_secondary; // assume matching base
        const N_attn_primary = N_attn_secondary * (attnRatioArr[0] / attnRatioArr[1]);
        const attnMeanDiameter = 2 * Math.sqrt(attnCoreArea / Math.PI) * 10; // mm
        const attnTurnLength = Math.PI * attnMeanDiameter / 1000; // m
        const wireLengthAttn = N_attn_primary * attnTurnLength;
        const resistanceAttn = wireLengthAttn * attnPriWireRes;
        const turnsPerLayerAttn = Math.floor(attnPriBobbinWidth / attnPriTurnPitch);
        const layersAttn = Math.ceil(N_attn_primary / turnsPerLayerAttn);
        const heightAttn = layersAttn * attnPriTurnPitch;
        const maxHeightAttn = attnPriBobbinWidth === 45 ? 20 : (attnPriBobbinWidth / 2 - 5);
        const attnWarn = document.getElementById("attnPriWarn");

        document.getElementById("attnPriTurns").textContent = N_attn_primary.toFixed(1);
        document.getElementById("attnPriLength").textContent = wireLengthAttn.toFixed(2);
        document.getElementById("attnPriDiam").textContent = attnMeanDiameter.toFixed(1);
        document.getElementById("attnPriHeight").textContent = heightAttn.toFixed(1);
        document.getElementById("attnPriR").textContent = resistanceAttn.toFixed(2);
        if (attnWarn) attnWarn.textContent = (heightAttn > maxHeightAttn) ? " (Warning: Too tall for bobbin)" : "";


        // --- Attenuation/Step-up Transformer Secondary Segment (Copper) ---
        const attnSecCopperWireRes = parseFloat(document.getElementById("attenSecCopperWireRes").value);
        const attnSecCopperTurnPitch = parseFloat(document.getElementById("attenSecCopperTurnPitch").value);
        const attnSecStainlessWireRes = parseFloat(document.getElementById("attenSecStainlessWireRes").value);
        const attnSecStainlessTurnPitch = parseFloat(document.getElementById("attenSecStainlessTurnPitch").value);
        const attnSecBobbinWidth = parseFloat(document.getElementById("attenSecBobbinWidth").value);
        const attenSecL = parseFloat(document.getElementById("attenSecL").value); // mH
        const L_attnSec = attenSecL / 1000;
        const N_attnSec = Math.sqrt((L_attnSec * 2) / (4e-7 * attnCoreArea / 1e4));
        const attnSecMeanDiameter = attnMeanDiameter;

        // Copper
        const attnSecTurnLengthCopper = Math.PI * attnSecMeanDiameter / 1000; // m
        const attnSecWireLengthCopper = N_attnSec * attnSecTurnLengthCopper;
        const attnSecResistanceCopper = attnSecWireLengthCopper * attnSecCopperWireRes;
        const attnSecTurnsPerLayerCopper = Math.floor(attnSecBobbinWidth / attnSecCopperTurnPitch);
        const attnSecLayersCopper = Math.ceil(N_attnSec / attnSecTurnsPerLayerCopper);
        const attnSecHeightCopper = attnSecLayersCopper * attnSecCopperTurnPitch;
        document.getElementById("attnSecTurnsCopper").textContent = N_attnSec.toFixed(1);
        document.getElementById("attnSecLengthCopper").textContent = attnSecWireLengthCopper.toFixed(2);
        document.getElementById("attnSecDiamCopper").textContent = attnSecMeanDiameter.toFixed(1);
        document.getElementById("attnSecHeightCopper").textContent = attnSecHeightCopper.toFixed(1);
        document.getElementById("attnSecRCopper").textContent = attnSecResistanceCopper.toFixed(2);
        document.getElementById("attnSecCCopper").textContent = (totalCap * 1e9).toFixed(2);

        // Stainless
        const attnSecTurnLengthStainless = Math.PI * attnSecMeanDiameter / 1000; // m
        const attnSecWireLengthStainless = N_attnSec * attnSecTurnLengthStainless;
        const attnSecResistanceStainless = attnSecWireLengthStainless * attnSecStainlessWireRes;
        const attnSecTurnsPerLayerStainless = Math.floor(attnSecBobbinWidth / attnSecStainlessTurnPitch);
        const attnSecLayersStainless = Math.ceil(N_attnSec / attnSecTurnsPerLayerStainless);
        const attnSecHeightStainless = attnSecLayersStainless * attnSecStainlessTurnPitch;
        document.getElementById("attnSecTurnsStainless").textContent = N_attnSec.toFixed(1);
        document.getElementById("attnSecLengthStainless").textContent = attnSecWireLengthStainless.toFixed(2);
        document.getElementById("attnSecDiamStainless").textContent = attnSecMeanDiameter.toFixed(1);
        document.getElementById("attnSecHeightStainless").textContent = attnSecHeightStainless.toFixed(1);
        document.getElementById("attnSecRStainless").textContent = attnSecResistanceStainless.toFixed(2);
        document.getElementById("attnSecCStainless").textContent = (totalCap * 1e9).toFixed(2);

        // Show which is used for simulation
        let used = 'Copper';
        if (document.getElementById('attenSecMaterialStainless').checked) used = 'Stainless Steel';
        document.getElementById('attnSecMaterialUsed').textContent = used;

        // For simulation, use only the selected material's values
        // (If you want to use these values in simulate(), you can check which is selected)

        // --- Totals (VIC) ---
        document.getElementById("vicTotalCap").textContent = (totalCap * 1e9).toFixed(2);
        document.getElementById("vicTotalRes").textContent = (resistance + vicSecResistance + vicPosChokeResistance + vicNegChokeResistance).toFixed(2);
        document.getElementById("vicTotalInd").textContent = (vicSecL + vicPosChokeL + vicNegChokeL).toFixed(2);
        document.getElementById("vicLmdTem").textContent = (N_secondary / N_primary).toFixed(2);

        // --- Totals (Attenuation/Step-up Transformer) ---
        // For now, just show segment values as total (could sum over segments if needed)
        document.getElementById("segAttnLmdTem").textContent = (N_attnSec / N_attn_primary).toFixed(2);
        document.getElementById("segMatchingCap").textContent = (totalCap * 1e9).toFixed(2);
        document.getElementById("segQFactor").textContent = (N_attnSec / attnSecResistance).toFixed(2);
        document.getElementById("segMismatch").textContent = ((N_attn_primary - N_attnSec) / N_attn_primary).toFixed(2);

      } catch (e) {
        console.warn("RecalculateDefaults skipped due to missing DOM elements:", e.message);
      }
    }
  </script>
</body>
</html>
